version: "3.8"

services:
  ytb-summary:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ytb-summary

    # Environment variables
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PYTHONUNBUFFERED=1

    # Mount volumes for output and audio cache
    volumes:
      - ./output:/app/output
      - ./audio_downloads:/app/src/audio_downloads

    # Default command (can be overridden)
    # Usage: docker-compose run ytb-summary <video_id> [options]
    entrypoint: ["python", "main.py"]

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # GPU-enabled service for Whisper ASR (optional)
  ytb-summary-gpu:
    build:
      context: .
      dockerfile: Dockerfile.gpu
    container_name: ytb-summary-gpu

    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PYTHONUNBUFFERED=1

    volumes:
      - ./output:/app/output
      - ./audio_downloads:/app/src/audio_downloads

    entrypoint: ["python", "main.py"]

    # GPU access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    profiles:
      - gpu # Only start with: docker-compose --profile gpu up
